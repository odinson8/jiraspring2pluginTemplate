<!-- 
Written by Veniture

TODO
İssue Link olsun
-->

$webResourceManager.requireResource("com.veniture.PortfolioManagement:PortfolioManagement-resources")

<html>

<head>
    <title>Flo Demo</title>

    <link href="https://nightly.datatables.net/css/jquery.dataTables.css" rel="stylesheet" type="text/css" />
    <script src="https://nightly.datatables.net/js/jquery.dataTables.js"></script>
    <link href="https://nightly.datatables.net/select/css/select.dataTables.css?_=9a6592f8d74f8f520ff7b22342fa1183.css" rel="stylesheet" type="text/css" />
    <script src="https://nightly.datatables.net/select/js/dataTables.select.js?_=9a6592f8d74f8f520ff7b22342fa1183"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/js/select2.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <style id="css">
        .th {
            text-align: left;
        }

        .td {
            max-width: 199px; word-wrap: break-word;
        }

    </style>

    <script>
        AJS.$(document).ready(function() {

            var table;
            displayFooter = function () {
                table = AJS.$('#projectsTable').DataTable();

                // Total over all pages
                var intVal = function (i) {
                    return typeof i === 'undefined' ? 0 : i * 1;
                };

                /*      var totalize_filtered = function (col) {
                          var data = table.column(col, {
                              search: 'applied'
                          }).data();
                          if (typeof data != 'undefined') {
                              return data
                                      .reduce(function (a, b) {
                                                  return intVal(a) + intVal(b);
                                              },
                                              0);
                          } else {
                              return 0;
                          }
                      };*/

                var totalize_selected = function (col) {
                    var data = table.cells('.selected', col).data();
                    if (typeof data != 'undefined') {
                        return data
                                .reduce(function (a, b) {
                                    if (b==="-"){
                                        b="0"
                                    }
                                            return intVal(a) + intVal(b);
                                        },
                                        0);
                    } else {
                        return 0;
                    }
                };
                var apply_footer = function (kapasite, col) {
                    var remaining=kapasite - totalize_selected(col);
                    var innerHtml;
                    if (remaining<0){
                        innerHtml= '' +'<aui-badge style="background: #c50409; color: #ffffff;">' +remaining + '</aui-badge>';
                    } else {
                        innerHtml= ' ' + (kapasite - totalize_selected(col));
                    }
                    AJS.$(table.column(col).footer()).html(innerHtml);
                };

                table.columns('th[class*="teams"]').indexes().each(function (e) {
                    apply_footer(table.column(e).header().getAttribute('remainingTime'), e);
                });
            };

            table = AJS.$('#projectsTable').DataTable({
                "ordering": false,
                select: true,
                // "columnDefs": [
                //     { "orderable": true, "targets": [0, 2, 3,] }
                // ],
                footerCallback: function (row, data, start, end, display) {
                    displayFooter();
                },
                "drawCallback": function( settings ) {
                    onpageSwitch();
                }
            });

            table.on( 'select deselect', function ( e, dt, type, indexes ) {
                if ( type === 'row' ) {
                    //var data = table.rows( indexes ).data().pluck( 'id' );
                    displayFooter();
                }
            } );

            // table.on('select.dt deselect.dt', function () {
            //     // displayFooter();
            //     // AJS.$('#projectsTable').dataTable().fnClearTable();
            // });

            AJS.$("#select2").select2();

            AJS.$("#customFieldList-select2").auiSelect2();
            // AJS.$("#customFieldList-select2").find('option').prop('selected', 'selected');


            AJS.$("#customFieldList-select2").on('select2-selecting', function (e) {
                //Header'ı göster
                AJS.$('#projectsTable > thead  th[data-override*="'+e.val+'"]').show();
                updateCustomFieldTableDatas(e.val);
                displayFooter();
                hideTableRowsAccordingToOncelikSlider(1);
            });

            // AJS.$( "#customFieldList-select2 > option").each(function(index) {
            //     AJS.$(this).prop("selected" , true);
            //     AJS.$("#customFieldList-select2").trigger("change");
            // });

            //AJS.$("#customFieldList-select2").trigger("select2:select");
            AJS.$("#customFieldList-select2").on("select2-removing", function(e) {
                AJS.$('#projectsTable > thead  th[data-override*="'+e.val+'"]').hide();
                AJS.$('#projectsTable > tbody  tr td[class*="'+e.val+'"]').hide();
                hideTableRowsAccordingToOncelikSlider(1);
            });

            function onpageSwitch(){
                var dinamikEklenenlerTableHeaderlar = AJS.$('#projectsTable > thead  th[class*="dinamikEklenenler"]:not([style*=none])');
                dinamikEklenenlerTableHeaderlar.each(function () {
                    var cfId=AJS.$(this).attr("data-override");
                    updateCustomFieldTableDatas(cfId);
                });
                hideTableRowsAccordingToOncelikSlider(1);
            }

                function updateCustomFieldTableDatas(cfId){
                //custom Field td'leri çeker bu
                var issueCFsectionInTable = AJS.$('#projectsTable > tbody  tr td[class*="'+cfId+'"]');
                var issueKeys =[];
                issueCFsectionInTable.each(function () {
                    //td'ın parent'ı tr'a gidio sonra tr'ın ilk sütunu yani issue key sütünunu çekio
                    var issueKey=AJS.$(this).parent().children().first().children().first().prop("innerHTML");
                    issueKeys.push(issueKey);
                    AJS.$(this).show();
                });

                    var cfValues=bulkGetCfValuesFromIssue(issueKeys.join(","),cfId);
                    //Burada kritik nokta cfValues length ile Table'daki row sayısı mutlaka aynı olmalı !!!
                    var array=cfValues.split(",,,");
                    for(var i = 0; i < array.length; i++) {
                        issueCFsectionInTable[i].innerHTML=array[i];
                        AJS.$(issueCFsectionInTable[i]).show();
                    }
            }

            function bulkGetCfValuesFromIssue(issueKeys, customfieldId){
                var value="-";
                jQuery.ajax({
                    url: AJS.params.baseURL + "/rest/florestservice/1.2/rest/bulkGetCfValueFromIssue",
                    type: 'POST',
                    data: {
                        issueKey: issueKeys,
                        customFieldId: customfieldId
                    },
                    async: false,
                    beforeSend: function () {
                        console.log("getCfValueFromIssue function started!");

                    },
                    error : function (response) {
                        value= "-";
                        console.log("getCfValueFromIssue ERROR!!!");
                    },
                    success: function (response, status, jqXHR) {
                        console.log("getCfValueFromIssue complete");
                        value= response;
                    }
                });
                return value;
            }

            /*            AJS.$("#customFieldList-select2").select2({
                            maximumSelectionLength: 6
                        });*/

            /*
                        AJS.$("#customFieldList-select2").on('select2:select', function (e) {
                                AJS.$('#projectsTable>tbody').find('tr').each(function(){
                                    var trow = AJS.$(this);
                                    var issueKey=trow.context.cells[0].innerText;

                                    jQuery.ajax({
                                        url: AJS.params.baseURL + "/rest/florestservice/1.2/rest/getCfValueFromIssue",
                                        type: 'GET',
                                        data: {
                                            issueKey: trow.context.cells[0].innerText,
                                            customFieldId: "customfield_10814"
                                        },
                                        async: false,
                                        beforeSend: function () {
                                        },
                                        complete: function (response) {
                                        },
                                        success: function (response, status, jqXHR) {
                                            trow.find('td').eq(1).after('<td> asd '+response.toString()+'</td>');
                                            console.log(response.toString());
                                        }
                                    });
                                });
                        });
            */

            AJS.$('#select2').live('change', function () {
                window.location.replace("https://jira.veniture.tk/plugins/servlet/projectapprove?action=" + this.value);

                //  AJS.$('#select2').val(this.value); // Change the value or make some change to the internal state
                //  AJS.$('#select2').trigger('change.select2'); // Notify only Select2 of changes
            });

            // AJS.$('#oncelik-range').jRange({
            //     from: 1,
            //     to: 10,
            //     step: 1,
            //     scale: [0,5,10],
            //     format: '%s',
            //     width: 300,
            //     showLabels: true,
            //     isRange : true
            // });

            // var handle = AJS.$( "#custom-handle" );
            // AJS.$( "#slider" ).slider({
            //     max: 50,
            //     create: function() {
            //         handle.text( $( this ).slider( "value" ) );
            //     },
            //     slide: function( event, ui ) {
            //         handle.text( ui.value );
            //     }
            // });

            AJS.$( "#slider-range" ).slider({
                range: true,
                min: 1,
                max: 100,
                step: 1,
                values: [ 1, 100 ],
                slide: function( event, ui ) {
                    AJS.$( "#amount" ).val( ui.values[ 0 ] + "-" +  ui.values[ 1 ] );
                }
            });

            AJS.$( "#amount" ).val( "" + AJS.$( "#slider-range" ).slider( "values", 0 ) +
                    "-" + AJS.$( "#slider-range" ).slider( "values", 1 ) );

            AJS.$( "#slider-range" ).on( "slidechange", function( event, ui ) {
                var values = AJS.$( "#slider-range" ).slider( "option", "values" );
                hideTableRowsAccordingToOncelikSlider(1);
                console.log(values);
            } );

            function hideTableRowsAccordingToOncelikSlider(cfId){
                try {
                    showHiddenTableRows();
                    //custom Field td'leri çeker bu
                    var issueCFsectionInTable = AJS.$('#projectsTable > tbody  tr td[class*="customfield_11403"]');
                    issueCFsectionInTable.each(function () {
                        //td'ın parent'ı tr'a gidio sonra tr'ın ilk sütunu yani issue key sütünunu çekio
                        var tableRow=AJS.$(this).parent();
                        var number=AJS.$(this).prop("innerHTML");
                        var integer = parseInt(number, 10);
                        var lowerBound = parseInt(AJS.$( "#slider-range" ).slider( "values", 0 ), 10);
                        var upperBound = parseInt(AJS.$( "#slider-range" ).slider( "values", 1 ), 10);

                        if(integer<= lowerBound|| integer>=upperBound){
                            tableRow.hide();
                        }
                    });                }
                catch(error) {
                    console.error(error);
                    // expected output: ReferenceError: nonExistentFunction is not defined
                    // Note - error messages will vary depending on browser
                }

            }

            function showHiddenTableRows(){
                AJS.$('#projectsTable > tbody tr:hidden').show();
            }

            AJS.$('#ApproveButton').off().on("click", function () {
                var berk = table.cells('.selected', 0);

                // var URL = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');
                console.log("asd");

                var selectedCellsArray = table.cells('.selected', 0).data().toArray();

                jQuery.ajax({
                    url: AJS.params.baseURL + "/rest/florestservice/1.2/rest/transitionissues",
                    type: 'GET',
                    data: {
                        issues: selectedCellsArray,
                        action: "approve"
                    },
                    async: true,
                    beforeSend: function () {
                        console.log(selectedCellsArray);

                    },
                    complete: function (response) {
                    },
                    error: function (response) {
                        Swal.fire(
                                'Hata!'
                        )
                    },
                    success: function (response, status, jqXHR) {

                        Swal.fire(
                                'Başarılı!',
                                'Projeler Onaylandı!',
                                'success'
                        )
                    }
                });
            })

            AJS.$('#DeclineButton').off().on("click", function () {

                // var URL = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');

                var selectedCellsArray = table.cells('.selected', 0).data().innerHTML.toArray();

                jQuery.ajax({
                    url: AJS.params.baseURL + "/rest/rest/1.2/florestservice/transitionissues",
                    type: 'GET',
                    data: {
                        issues: selectedCellsArray,
                        action: "decline"
                    },
                    async: true,
                    beforeSend: function () {
                    },
                    complete: function (response) {
                    },
                    error: function (response) {
                        Swal.fire(
                                'Hata!'
                        )
                    },
                    success: function (response, status, jqXHR) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Reddedildi',
                            text: 'Projeler reddedildi!'})
                    }
                });
            })
        });
    </script>
    <meta name="decorator" content="atl.general">
</head>

<body id="jira>
    <div class=" content-container">
<div class="content-body">
    <div class="aui-group">
        <header class="aui-page-header">
            <div class="aui-page-header-inner">
                <div class="aui-page-header-image">
                    <span class="aui-avatar aui-avatar-large aui-avatar-project">
                        <span class="aui-avatar-inner">
                            <img alt="FLO project" src="https://www.flo.com.tr/pub/assets/flo/img/logo.svg">
                        </span>
                    </span>
                </div>
                <div class="aui-page-header-main">
                    <div class="aui-help aui-help-empty-state">
                        <div class="aui-help-content">
                            <h1>Proje Onaylama</h1>
                            <p>Projeleri seçiniz ve onayla butonuna basınız. Birden fazla proje seçmek için CTRL tuşuna basılı tutun.</p>
                            <p>Sonradan eklenen Özel Alanlar tablonun sağ tarafına eklenecektir.</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </div>

##    <div class="aui-group">
##        <div class="aui-item" id="jqlFilter">
##            <form class="aui">
##                <select id="select2" data-placeholder="Select a filter" style="width: 60%">
##                    <option></option>
##                    <option value="PLANLAMA">PLANLAMA</option>
##                    <option value="SATISARTTIRAN">SATISARTTIRAN</option>
##                    <option value="WFA">WFA</option>
##                </select>
##            </form>
##        </div>
##    </div>

##                <div class="aui-group">
##                    <div class="aui-item" id="customFieldList">
##                        <form class="aui">
##                            <select id="customFieldList-select2" data-placeholder="Select Fields" multiple style="width: 40%">
##                                <option></option>
##                                #foreach($cf in $projectCFs)
##                                    <option value="$cf.getId()">$cf.getFieldName()</option>
##                                #end
##                            </select>
##                        </form>
##                    </div>
##                </div>

    <div class="aui-group">
        <div class="aui-item" id="#select2-customFields">
            <form class="aui">
                <select id="customFieldList-select2" data-placeholder="Alan eklemek için tıklayın." multiple style="width: 40%">
                    <option></option>
                    #foreach($cf in $customFieldsInProject)
                        <option value="$cf.getId()">$cf.getFieldName()</option>
                    #end
                </select>
            </form>
        </div>
        <div class="aui-item" id="#oncelikler-aui-item">
            <p>
                <label for="amount">WIP: Öncelik Aralığı:</label>
                <input type="text" id="amount" readonly style="border:0; color:#f6931f; font-weight:bold;">
            </p>
            <div id="slider-range"></div>
        </div>
    </div>

    <a id="clickable-label" class="aui-label" href="projectapprove">WIP: Satış arttıran</a>
    <a id="clickable-label" class="aui-label" href="projectapprove">WIP: Maliyet Azaltan</a>

    <div class="aui-group">
        <div class="aui-item" id="issueTableDiv">
            <table id="projectsTable" class=" display nowrap" width="100%">
                <thead>
                <tr>
                    <th style="text-align: left;">Key</th>
                    <th style="text-align: left;">Summary</th>
                    #foreach($program in $programs)
                        <th class="program" style="text-align: center;">$program.getName()</th>
                    #end
                    #foreach($cf in $customFieldsInProject)
                        <th style="display:none;" class="dinamikEklenenler" data-override="$cf.getId()">$cf.getName()</th>
                    #end
                </tr>
                </thead>
                <tfoot>
                <tr>
                    <th></th>
                    <th>Kalan</th>
                    #foreach($program in $programs)
                        <th class="program" style="text-align: center;">$program.getCapacity()</th>
                    #end
                    #foreach($cf in $customFieldsInProject)
                        <th style="display:none;" class="dinamikEklenenler" data-override="$cf.getId()">$cf.getName()</th>
                    #end
                </tr>
                </tfoot>
                <tbody>
                    #foreach( $IssueWithCF in $issuesWithCF )
                    <tr>
                        #set ($issue=$IssueWithCF.getIssue())
##                        Burada bişi değiştirirken dikkat et, buralara referans atan updateCF fonksiyonu var
                        <td><a href="$baseUrl/browse/$issue.getKey()">$issue.getKey()</a></td>
                        <td>$issue.getSummary()</td>
                        #foreach($eforCf in $eforCfs)
                            <td class="eforCf" style="text-align: center;">#if( $eforCf.getValue($issue) )  $eforCf.getValue($issue) #else "888" #end</td>
                        #end

                        #foreach($cf in $customFieldsInProject)
                            <td style="display:none; text-align: center;" class="$cf.getId()">-</td>
                        #end
                    </tr>
                    #end
                </tbody>
            </table>
            <button class="aui-button aui-button-primary" id="ApproveButton">Projeleri Onayla</button>
            <button class="aui-button" id="DeclineButton">Projeleri Reddet</button>
        </div>
    </div>
</div>
</div>
</body>
</html>